# Authentication API Guide

## Overview
Authentication API cho h·ªá th·ªëng OEM EV Warranty Management s·ª≠ d·ª•ng JWT tokens.

## Base URL
```
http://localhost:8080/api/auth
```

## Endpoints

### 1. Login - ƒêƒÉng nh·∫≠p
**POST** `/api/auth/login`

**Description:** ƒêƒÉng nh·∫≠p v√† nh·∫≠n JWT tokens

**Request:**
```json
{
  "username": "admin",
  "password": "password123"
}
```

**Response Success (200):**
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJhZG1pbiIsImlhdCI6MTY5NjgzODQwMCwiZXhwIjoxNjk2ODQyMDAwfQ...",
  "refreshToken": "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJhZG1pbiIsImlhdCI6MTY5NjgzODQwMCwiZXhwIjoxNjk3NDQzMjAwfQ...",
  "message": "Login successful",
  "userId": 1,
  "username": "admin",
  "roleName": "ADMIN"
}
```

**Response Error (401):**
```json
{
  "accessToken": null,
  "refreshToken": null,
  "message": "Invalid credentials",
  "userId": null,
  "username": null,
  "roleName": null
}
```

**Postman Setup:**
```
Method: POST
URL: http://localhost:8080/api/auth/login
Headers:
  Content-Type: application/json
Body (raw JSON):
{
  "username": "admin",
  "password": "password123"
}
```

### 2. Register - ƒêƒÉng k√Ω Customer (Ch·ªâ d√†nh cho SC Staff)
**POST** `/api/auth/register`

**Description:** ƒêƒÉng k√Ω customer m·ªõi (ch·ªâ SC Staff m·ªõi c√≥ quy·ªÅn)

**Request:**
```json
{
  "username": "newcustomer",
  "email": "customer@example.com",
  "password": "password123",
  "address": "123 Main St, Ho Chi Minh City"
}
```

**Response Success (201):**
```json
{
  "success": true,
  "message": "Customer account created successfully",
  "user": {
    "userId": 5,
    "username": "newcustomer",
    "roleName": "CUSTOMER"
  }
}
```

**Response Error (400):**
```json
{
  "success": false,
  "message": "Username already exists"
}
```

### 3. Admin Create User - T·∫°o user b·ªüi Admin
**POST** `/api/auth/admin/create-user`

**Description:** Admin t·∫°o user v·ªõi b·∫•t k·ª≥ role n√†o

**Headers:**
```
Authorization: Bearer {admin_access_token}
```

**Request:**
```json
{
  "username": "new_staff",
  "email": "staff@example.com",
  "password": "password123",
  "address": "456 Staff St, Ho Chi Minh City",
  "roleId": 2
}
```

**Response Success (201):**
```json
{
  "success": true,
  "message": "User created successfully by Admin",
  "user": {
    "userId": 6,
    "username": "new_staff",
    "roleName": "EVM_STAFF"
  }
}
```

### 4. Staff Register Customer - ƒêƒÉng k√Ω Customer ƒë·∫ßy ƒë·ªß b·ªüi Staff
**POST** `/api/auth/staff/register-customer`

**Description:** ADMIN, SC_STAFF ho·∫∑c EVM_STAFF ƒëƒÉng k√Ω customer m·ªõi v·ªõi ƒë·∫ßy ƒë·ªß th√¥ng tin User + Customer trong 1 request

**Permissions:** ADMIN, SC_STAFF, EVM_STAFF only

**Headers:**
```
Authorization: Bearer {staff_access_token}
Content-Type: application/json
```

**Request:**
```json
{
  "username": "nguyenvana",
  "email": "nguyenvana@example.com",
  "password": "password123",
  "address": "123 Nguyen Hue, Quan 1, TP.HCM",
  "name": "Nguy·ªÖn VƒÉn A",
  "phone": "+84901234567"
}
```

**Response Success (201):**
```json
{
  "success": true,
  "message": "Customer account and profile created successfully",
  "customer": {
    "customerId": "123e4567-e89b-12d3-a456-426614174000",
    "name": "Nguy·ªÖn VƒÉn A",
    "email": "nguyenvana@example.com",
    "phone": "+84901234567",
    "address": "123 Nguyen Hue, Quan 1, TP.HCM",
    "createdAt": "2024-10-21T10:30:00.000+00:00",
    "userId": 10,
    "username": "nguyenvana"
  }
}
```

**Response Error (400):**
```json
{
  "success": false,
  "message": "Username already exists: nguyenvana"
}
```

**Postman Setup:**
```
Method: POST
URL: http://localhost:8080/api/auth/staff/register-customer
Headers:
  Authorization: Bearer {{accessToken}}
  Content-Type: application/json
Body (raw JSON):
{
  "username": "nguyenvana",
  "email": "nguyenvana@example.com",
  "password": "password123",
  "address": "123 Nguyen Hue, Quan 1, TP.HCM",
  "name": "Nguy·ªÖn VƒÉn A",
  "phone": "+84901234567"
}
```

**Validation Rules:**
- **Username:** 3-50 k√Ω t·ª±, ch·ªâ ch·ªØ c√°i, s·ªë v√† underscore
- **Email:** Format email h·ª£p l·ªá, unique trong h·ªá th·ªëng
- **Password:** T·ªëi thi·ªÉu 6 k√Ω t·ª±
- **Address:** 10-255 k√Ω t·ª±
- **Name:** 5-100 k√Ω t·ª±, m·ªói t·ª´ vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu, h·ªó tr·ª£ ti·∫øng Vi·ªát
- **Phone:** Format Vi·ªát Nam (+84xxxxxxxxx ho·∫∑c 0xxxxxxxxx), unique trong h·ªá th·ªëng

**Note:** Endpoint n√†y t·∫°o ƒë·ªìng th·ªùi c·∫£ User account (v·ªõi role CUSTOMER) v√† Customer profile, kh√°c v·ªõi `/api/auth/register` ch·ªâ t·∫°o User account.

### 5. Refresh Token
**POST** `/api/auth/refresh`

**Description:** L√†m m·ªõi access token b·∫±ng refresh token

**Request:**
```json
{
  "refreshToken": "eyJhbGciOiJIUzI1NiJ9..."
}
```

**Response Success (200):**
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiJ9...",
  "message": "Token refreshed successfully",
  "userId": 1,
  "username": "admin",
  "roleName": "ADMIN"
}
```

### 5. Logout
**POST** `/api/auth/logout`

**Description:** ƒêƒÉng xu·∫•t v√† v√¥ hi·ªáu h√≥a refresh token

**Request:**
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiJ9..."
}
```

**Response Success (200):**
```json
{
  "success": true,
  "message": "Logged out successfully"
}
```

**Response Error (400):**
```json
{
  "success": false,
  "message": "Invalid token"
}
```

### 6. Forgot Password
**POST** `/api/auth/forgot-password`

**Request:**
```json
{
  "email": "user@example.com"
}
```

**Response Success (200):**
```json
{
  "success": true,
  "message": "Password reset email sent"
}
```

**Response Error (400):**
```json
{
  "success": false,
  "message": "Email not found"
}
```

### 7. Reset Password
**POST** `/api/auth/reset-password`

**Request:**
```json
{
  "resetToken": "uuid-reset-token",
  "newPassword": "newpassword123",
  "confirmPassword": "newpassword123"
}
```

**Response Success (200):**
```json
{
  "success": true,
  "message": "Password reset successfully"
}
```

**Response Error (400):**
```json
{
  "success": false,
  "message": "Invalid or expired reset token"
}
```

### 8. Validate Token
**GET** `/api/auth/validate`

**Headers:**
```
Authorization: Bearer {access_token}
```

**Request:**
Kh√¥ng c·∫ßn body.

**Response Success (200):**
```json
{
  "accessToken": null,
  "refreshToken": null,
  "message": "Token is valid",
  "userId": 1,
  "username": "admin",
  "roleName": "ADMIN"
}
```

**Response Error (401):**
```json
{
  "accessToken": null,
  "refreshToken": null,
  "message": "Invalid Authorization header format",
  "userId": null,
  "username": null,
  "roleName": null
}
```

**Postman Setup:**
```
Method: GET
URL: http://localhost:8080/api/auth/validate
Headers:
  Authorization: Bearer <access_token>
```

> L∆∞u √Ω: Ch·ªâ c·∫ßn g·ª≠i header Authorization, kh√¥ng c·∫ßn g·ª≠i body hay params.

## Postman Collection Setup

### 1. T·∫°o Environment Variables
T·∫°o environment trong Postman v√† th√™m c√°c variables:

**Environment Name:** `OEM EV Warranty API`

**Variables:**
```
baseUrl: http://localhost:8080
accessToken: {{accessToken}}
refreshToken: {{refreshToken}}
```

### 2. Pre-request Script cho Login
Th√™m v√†o tab **Pre-request Script** c·ªßa request Login:

```javascript
// Clear previous tokens
pm.environment.unset("accessToken");
pm.environment.unset("refreshToken");
```

### 3. Tests Script cho Login
Th√™m v√†o tab **Tests** c·ªßa request Login:

```javascript
// Parse response
var jsonData = pm.response.json();

// Set tokens to environment
if (jsonData.accessToken) {
    pm.environment.set("accessToken", jsonData.accessToken);
    console.log("Access Token saved:", jsonData.accessToken);
}

if (jsonData.refreshToken) {
    pm.environment.set("refreshToken", jsonData.refreshToken);
    console.log("Refresh Token saved:", jsonData.refreshToken);
}

// Test response
pm.test("Login successful", function () {
    pm.response.to.have.status(200);
    pm.expect(jsonData).to.have.property("accessToken");
    pm.expect(jsonData).to.have.property("refreshToken");
    pm.expect(jsonData).to.have.property("username");
    pm.expect(jsonData).to.have.property("roleName");
});
```

### 4. S·ª≠ d·ª•ng Token cho C√°c API Kh√°c

**C√°ch 1: Manual Header**
```
Headers:
  Authorization: Bearer {{accessToken}}
  Content-Type: application/json
```

**C√°ch 2: Authorization Tab**
1. Ch·ªçn tab **Authorization**
2. Type: **Bearer Token**
3. Token: `{{accessToken}}`

### 5. Auto-refresh Token khi Expired

**Pre-request Script cho t·∫•t c·∫£ protected endpoints:**

```javascript
// Check if access token exists
const accessToken = pm.environment.get("accessToken");
const refreshToken = pm.environment.get("refreshToken");

if (!accessToken && refreshToken) {
    // Auto refresh token
    const refreshRequest = {
        url: pm.environment.get("baseUrl") + "/api/auth/refresh",
        method: 'POST',
        header: {
            'Content-Type': 'application/json'
        },
        body: {
            mode: 'raw',
            raw: JSON.stringify({
                "refreshToken": refreshToken
            })
        }
    };
    
    pm.sendRequest(refreshRequest, function (err, response) {
        if (err) {
            console.log("Refresh token failed:", err);
        } else {
            const jsonData = response.json();
            if (jsonData.accessToken) {
                pm.environment.set("accessToken", jsonData.accessToken);
                pm.environment.set("refreshToken", jsonData.refreshToken);
                console.log("Token refreshed successfully");
            }
        }
    });
}
```

## Sample Postman Collection

### Collection Structure:
```
üìÅ OEM EV Warranty API
‚îú‚îÄ‚îÄ üìÅ Auth
‚îÇ   ‚îú‚îÄ‚îÄ üîë Login (Admin)
‚îÇ   ‚îú‚îÄ‚îÄ üîë Login (EVM Staff) 
‚îÇ   ‚îú‚îÄ‚îÄ üîë Login (SC Staff)
‚îÇ   ‚îú‚îÄ‚îÄ üîë Login (SC Technician)
‚îÇ   ‚îú‚îÄ‚îÄ üîë Login (Customer)
‚îÇ   ‚îú‚îÄ‚îÄ üìù Register Customer (by SC Staff)
‚îÇ   ‚îú‚îÄ‚îÄ üë®‚Äçüíº Admin Create User
‚îÇ   ‚îú‚îÄ‚îÄ üîÑ Refresh Token
‚îÇ   ‚îú‚îÄ‚îÄ ‚úÖ Validate Token
‚îÇ   ‚îú‚îÄ‚îÄ üîí Forgot Password
‚îÇ   ‚îú‚îÄ‚îÄ üîë Reset Password
‚îÇ   ‚îî‚îÄ‚îÄ üö™ Logout
‚îú‚îÄ‚îÄ üìÅ Vehicles
‚îÇ   ‚îú‚îÄ‚îÄ üìã Get All Vehicles
‚îÇ   ‚îú‚îÄ‚îÄ üëÅÔ∏è Get Vehicle by ID
‚îÇ   ‚îú‚îÄ‚îÄ ‚ûï Create Vehicle
‚îÇ   ‚îú‚îÄ‚îÄ ‚úèÔ∏è Update Vehicle
‚îÇ   ‚îî‚îÄ‚îÄ ‚ùå Delete Vehicle
‚îú‚îÄ‚îÄ üìÅ Customers
‚îÇ   ‚îú‚îÄ‚îÄ üìã Get All Customers
‚îÇ   ‚îú‚îÄ‚îÄ üëÅÔ∏è Get Customer by ID
‚îÇ   ‚îú‚îÄ‚îÄ üë§ Get My Profile
‚îÇ   ‚îú‚îÄ‚îÄ ‚ûï Create Customer
‚îÇ   ‚îî‚îÄ‚îÄ ‚úèÔ∏è Update Customer
‚îú‚îÄ‚îÄ üìÅ Parts
‚îú‚îÄ‚îÄ üìÅ Warranty Claims
‚îî‚îÄ‚îÄ üìÅ Service Histories
```

## Default Test Accounts

### Admin Account
```json
{
  "username": "admin",
  "password": "password123"
}
```
**Role:** ADMIN  
**Permissions:** Full access to all endpoints

### EVM Staff Account  
```json
{
  "username": "evm_staff",
  "password": "password123"
}
```
**Role:** EVM_STAFF  
**Permissions:** Vehicles, Parts (CRUD), Customers (Read)

### SC Staff Account
```json
{
  "username": "sc_staff", 
  "password": "password123"
}
```
**Role:** SC_STAFF  
**Permissions:** All except user management

### SC Technician Account
```json
{
  "username": "sc_tech",
  "password": "password123"
}
```
**Role:** SC_TECHNICIAN  
**Permissions:** Warranty Claims, Service Histories, Vehicles (Read)

### Customer Account
```json
{
  "username": "customer",
  "password": "password123"
}
```
**Role:** CUSTOMER  
**Permissions:** Own data only

## Common Error Responses

### 401 Unauthorized
```json
{
  "timestamp": "2024-10-13T10:15:30.000+00:00",
  "status": 401,
  "error": "Unauthorized", 
  "message": "JWT token is missing or invalid",
  "path": "/api/vehicles"
}
```

### 403 Forbidden
```json
{
  "timestamp": "2024-10-13T10:15:30.000+00:00",
  "status": 403,
  "error": "Forbidden",
  "message": "Access denied. Insufficient permissions",
  "path": "/api/admin/users"
}
```

### 422 Token Expired
```json
{
  "timestamp": "2024-10-13T10:15:30.000+00:00",
  "status": 422,
  "error": "Unprocessable Entity",
  "message": "JWT token has expired",
  "path": "/api/vehicles"
}
```

## Tips & Best Practices

### 1. Token Management
- Always save `accessToken` v√† `refreshToken` t·ª´ login response
- S·ª≠ d·ª•ng environment variables trong Postman
- Implement auto-refresh mechanism

### 2. Testing Different Roles
- T·∫°o separate requests cho m·ªói role
- Use descriptive names: "Login (Admin)", "Login (Customer)"
- Test permissions thoroughly

### 3. Error Handling
- Always check response status codes
- Handle 401/403 errors gracefully
- Implement retry logic for expired tokens

### 4. Security
- Kh√¥ng hardcode tokens trong requests
- Use environment variables
- Clear tokens khi logout

### 5. Debugging
- Check console logs for token values
- Verify token format (should start with "eyJ")
- Use jwt.io ƒë·ªÉ decode v√† ki·ªÉm tra token content

### 6. Role-based Access
- **Register endpoint**: Ch·ªâ SC Staff m·ªõi c√≥ th·ªÉ t·∫°o customer account
- **Admin Create User**: Ch·ªâ Admin m·ªõi c√≥ th·ªÉ t·∫°o account v·ªõi b·∫•t k·ª≥ role n√†o
- **Customer t·ª± ƒëƒÉng k√Ω**: Hi·ªán t·∫°i kh√¥ng c√≥ endpoint, ph·∫£i th√¥ng qua SC Staff
