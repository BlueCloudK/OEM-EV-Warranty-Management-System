# JWT Authentication & Authorization Flow Guide

## üìã T·ªïng quan h·ªá th·ªëng

H·ªá th·ªëng OEM EV Warranty Management s·ª≠ d·ª•ng JWT (JSON Web Token) ƒë·ªÉ x√°c th·ª±c v√† ph√¢n quy·ªÅn ng∆∞·ªùi d√πng.

**Last Updated:** October 23, 2025 - Th√™m t√≠nh nƒÉng Customer xem warranty claims

---

## üîê JWT Flow - T√ìM T·∫ÆT NG·∫ÆN G·ªåN

### **B∆∞·ªõc 1: Login (ƒêƒÉng nh·∫≠p)**
```
POST /api/auth/login
{ "username": "customer1", "password": "123456" }

‚Üí Server verify credentials
‚Üí Generate 2 tokens:
   ‚Ä¢ accessToken (expire ~15-30 ph√∫t)
   ‚Ä¢ refreshToken (expire ~7 ng√†y)

Response:
{
  "accessToken": "eyJhbGci...",
  "refreshToken": "eyJhbGci...",
  "tokenType": "Bearer",
  "userId": 123,
  "username": "customer1",
  "roleName": "CUSTOMER"
}
```

### **B∆∞·ªõc 2: S·ª≠ d·ª•ng API v·ªõi JWT**
```
GET /api/warranty-claims/my-claims
Header: Authorization: Bearer <accessToken>

‚Üí JwtAuthenticationFilter verify token
‚Üí Extract username & roles
‚Üí Set SecurityContext
‚Üí @PreAuthorize check role
‚Üí Return data (n·∫øu c√≥ quy·ªÅn)
```

### **B∆∞·ªõc 3: Access Token h·∫øt h·∫°n ‚Üí Refresh**
```
GET /api/warranty-claims/my-claims
Header: Authorization: Bearer <expired_token>

‚Üí Response: 401 Unauthorized

Client detect 401 ‚Üí Call refresh:
POST /api/auth/refresh
{ "refreshToken": "eyJhbGci..." }

‚Üí Response: New accessToken
‚Üí Retry API v·ªõi token m·ªõi
```

### **B∆∞·ªõc 4: Refresh Token c≈©ng h·∫øt h·∫°n ‚Üí Re-login**
```
POST /api/auth/refresh
{ "refreshToken": "expired_refresh_token" }

‚Üí Response: 401 Unauthorized
‚Üí Redirect user v·ªÅ Login page
```

### **B∆∞·ªõc 5: Logout**
```
POST /api/auth/logout
{ "refreshToken": "..." }

‚Üí Server revoke token
‚Üí Client x√≥a tokens
```

---

## üìä JWT Flow Diagram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    Client    ‚îÇ
‚îÇ  (Browser)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îÇ 1. POST /login (username + password)
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       AuthController            ‚îÇ
‚îÇ   ‚Üí AuthService                 ‚îÇ
‚îÇ   - Verify credentials          ‚îÇ
‚îÇ   - Generate accessToken        ‚îÇ
‚îÇ   - Generate refreshToken       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚îÇ 2. Return tokens
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Client saves tokens           ‚îÇ
‚îÇ   - accessToken ‚Üí memory        ‚îÇ
‚îÇ   - refreshToken ‚Üí localStorage ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚îÇ 3. API Request + accessToken
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  JwtAuthenticationFilter        ‚îÇ
‚îÇ  - Extract JWT from header      ‚îÇ
‚îÇ  - Validate JWT                 ‚îÇ
‚îÇ  - Extract username + roles     ‚îÇ
‚îÇ  - Set SecurityContext          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚îÇ 4. Check role permission
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  @PreAuthorize("hasRole(...)")  ‚îÇ
‚îÇ  - Allow or Deny                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚îÇ 5. Execute business logic
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Controller ‚Üí Service ‚Üí DB      ‚îÇ
‚îÇ  Return response                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîë JWT Token Structure

```
JWT = Header.Payload.Signature

Header:
{
  "alg": "HS256",
  "typ": "JWT"
}

Payload:
{
  "sub": "customer1",       ‚Üê Username
  "role": "CUSTOMER",       ‚Üê Role
  "iat": 1698123456,        ‚Üê Issued At
  "exp": 1698125256         ‚Üê Expiration
}

Signature:
HMACSHA256(
  base64UrlEncode(header) + "." + base64UrlEncode(payload),
  SECRET_KEY
)
```

---

## ‚öôÔ∏è Security Config

```java
// STATELESS - Kh√¥ng l∆∞u session
.sessionManagement(session ->
    session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))

// JWT Filter tr∆∞·ªõc UsernamePasswordAuthenticationFilter
.addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class)

// Public endpoints
.requestMatchers("/api/auth/login", "/api/auth/register", "/api/auth/refresh")
    .permitAll()

// Protected endpoints
.requestMatchers("/api/warranty-claims/my-claims/**").hasRole("CUSTOMER")
.requestMatchers("/api/warranty-claims/**").hasAnyRole("ADMIN", "SC_STAFF", "SC_TECHNICIAN", "EVM_STAFF")
```

---

## üîê C√°c Role trong h·ªá th·ªëng

1. **ADMIN** - Qu·∫£n tr·ªã vi√™n h·ªá th·ªëng
   - C√≥ th·ªÉ CRUD t·∫•t c·∫£ resources
   - Truy c·∫≠p t·∫•t c·∫£ endpoints
   - Qu·∫£n l√Ω users v√† roles
   - Duy nh·∫•t c√≥ quy·ªÅn DELETE h·∫ßu h·∫øt resources

2. **EVM_STAFF** - Nh√¢n vi√™n nh√† s·∫£n xu·∫•t xe ƒëi·ªán
   - CRUD vehicles v√† parts (tr·ª´ DELETE parts - ch·ªâ ADMIN)
   - CRU customers (kh√¥ng DELETE)
   - **Workflow**: Xem x√©t v√† ch·∫•p nh·∫≠n/t·ª´ ch·ªëi warranty claims
   - **‚úÖ NEW**: C√≥ quy·ªÅn truy c·∫≠p Service Histories ƒë·ªÉ theo d√µi completion

3. **SC_STAFF** - Nh√¢n vi√™n trung t√¢m b·∫£o h√†nh
   - CRUD customers, vehicles, warranty claims, service histories
   - READ parts (kh√¥ng th·ªÉ CUD parts)
   - **Workflow**: T·∫°o warranty claims cho kh√°ch h√†ng
   - Qu·∫£n l√Ω to√†n b·ªô quy tr√¨nh b·∫£o h√†nh

4. **SC_TECHNICIAN** - K·ªπ thu·∫≠t vi√™n trung t√¢m b·∫£o h√†nh
   - READ vehicles, parts
   - RU warranty claims (kh√¥ng th·ªÉ CREATE/DELETE)
   - CRUD service histories
   - **Workflow**: X·ª≠ l√Ω warranty claims (start/complete processing)
   - **Kh√¥ng c√≥ access**: Customers management

5. **CUSTOMER** - Kh√°ch h√†ng
   - READ vehicles c·ªßa m√¨nh (qua `/my-vehicles`)
   - READ parts information
   - **üÜï READ warranty claims c·ªßa m√¨nh** (qua `/my-claims` - NEW Oct 23, 2025)
   - **‚ùå KH√îNG TH·ªÇ t·∫°o warranty claims** - ph·∫£i ƒë·∫øn service center
   - READ service histories c·ªßa vehicles m√¨nh s·ªü h·ªØu (qua `/my-services`)
   - Self-service: Update profile qua `/profile`

## üöÄ Flow Authentication (ƒêƒÉng nh·∫≠p)

### 1. User Login
```
POST /api/auth/login
Body: {
  "username": "admin",
  "password": "admin123"
}
```

### 2. Server x·ª≠ l√Ω
```
AuthController.login()
  ‚Üì
AuthService.authenticateUser()
  ‚Üì
1. T√¨m user trong database (UserRepository.findByUsername())
2. Verify password v·ªõi BCrypt
3. Generate JWT access token (JwtService.generateToken())
4. Generate refresh token (JwtService.generateRefreshToken())
5. L∆∞u refresh token v√†o database
```

### 3. Response tr·∫£ v·ªÅ
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiJ9...",
  "message": "Login successful",
  "userId": 1,
  "username": "admin",
  "roleName": "ADMIN"
}
```

## üîí Flow Authorization (Ph√¢n quy·ªÅn)

### 1. Client g·ª≠i request v·ªõi JWT
```
POST /api/vehicles
Headers: {
  "Authorization": "Bearer eyJhbGciOiJIUzI1NiJ9...",
  "Content-Type": "application/json"
}
Body: {
  "vehicleName": "Tesla Model 3",
  "vehicleVin": "1HGBH41JXMN109186"
}
```

### 2. Spring Security Filter Chain
```
Request v√†o h·ªá th·ªëng
  ‚Üì
JwtAuthenticationFilter.doFilterInternal()
  ‚Üì
1. Extract token t·ª´ Authorization header
2. Validate token format (Bearer xxx)
3. Extract username t·ª´ JWT (JwtService.extractUsername())
4. Load UserDetails t·ª´ database (CustomUserDetailsService.loadUserByUsername())
5. Validate JWT token (JwtService.isTokenValid())
6. Set Authentication trong SecurityContext
  ‚Üì
SecurityFilterChain ki·ªÉm tra @PreAuthorize
  ‚Üì
Controller method ƒë∆∞·ª£c g·ªçi n·∫øu c√≥ quy·ªÅn
```

### 3. Method-level Security
```java
@PostMapping("/vehicles")
@PreAuthorize("hasRole('ADMIN') or hasRole('EVM_STAFF')")
public ResponseEntity<VehicleResponseDTO> createVehicle(@RequestBody VehicleRequestDTO request) {
    // Code ch·ªâ ch·∫°y n·∫øu user c√≥ role ADMIN ho·∫∑c EVM_STAFF
}
```

## üìä Flow x√°c ƒë·ªãnh User hi·ªán t·∫°i

### 1. Trong Controller
```java
@PostMapping("/vehicles")
public ResponseEntity<?> createVehicle(@RequestBody VehicleRequestDTO request) {
    // L·∫•y th√¥ng tin user hi·ªán t·∫°i
    String currentUser = SecurityUtil.getCurrentUsername();
    Set<String> roles = SecurityUtil.getCurrentRoles();
    
    // Log ƒë·ªÉ audit
    logger.info("User: {} creating vehicle with roles: {}", currentUser, roles);
    
    // X·ª≠ l√Ω logic theo role
    if (SecurityUtil.hasRole("ADMIN")) {
        // Logic cho Admin
    } else if (SecurityUtil.hasRole("EVM_STAFF")) {
        // Logic cho EVM Staff
    }
}
```

### 2. SecurityUtil Flow
```
SecurityUtil.getCurrentUsername()
  ‚Üì
SecurityContextHolder.getContext().getAuthentication()
  ‚Üì
Authentication.getName() ‚Üí return username
```

## üîÑ Flow Refresh Token

### 1. Access token h·∫øt h·∫°n
```
Client request ‚Üí Server response 401 Unauthorized
```

### 2. Client refresh token
```
POST /api/auth/refresh
Body: {
  "refreshToken": "eyJhbGciOiJIUzI1NiJ9..."
}
```

### 3. Server x·ª≠ l√Ω
```
AuthService.refreshUserToken()
  ‚Üì
1. Validate refresh token t·ª´ database
2. Ki·ªÉm tra expiration date
3. Generate new access token
4. Generate new refresh token
5. Update refresh token trong database
6. Return new tokens
```

## üõ°Ô∏è Security Features

### 1. Password Encryption
```
User password ‚Üí BCryptPasswordEncoder ‚Üí Hashed password l∆∞u trong DB
```

### 2. JWT Token Structure
```
Header: {
  "alg": "HS256",
  "typ": "JWT"
}

Payload: {
  "sub": "username",
  "iat": 1696838400,
  "exp": 1696842000
}

Signature: HMACSHA256(base64UrlEncode(header) + "." + base64UrlEncode(payload), secret)
```

### 3. Token Validation
```
JwtService.isTokenValid()
  ‚Üì
1. Check token format
2. Verify signature v·ªõi secret key
3. Check expiration date
4. Validate username
```

## üì± API Endpoints Security Matrix (CH√çNH X√ÅC THEO IMPLEMENTATION - UPDATED)

| Endpoint | ADMIN | EVM_STAFF | SC_STAFF | SC_TECHNICIAN | CUSTOMER |
|----------|-------|-----------|----------|---------------|----------|
| **VEHICLES** |
| `GET /api/vehicles` | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| `POST /api/vehicles` | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| `GET /api/vehicles/{id}` | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚úÖ (v·ªõi business logic filtering) |
| `PUT /api/vehicles/{id}` | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| `DELETE /api/vehicles/{id}` | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| `GET /api/vehicles/my-vehicles` | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| `GET /api/vehicles/by-customer/{id}` | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| `GET /api/vehicles/by-vin` | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| `GET /api/vehicles/search` | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚úÖ |
| `GET /api/vehicles/warranty-expiring` | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| **PARTS** |
| `GET /api/parts` | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| `GET /api/parts/{id}` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `POST /api/parts` | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| `PUT /api/parts/{id}` | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| `DELETE /api/parts/{id}` | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| `GET /api/parts/by-vehicle/{id}` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `GET /api/parts/by-manufacturer` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| `GET /api/parts/warranty-expiring` | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| **CUSTOMERS** |
| `GET /api/customers` | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| `GET /api/customers/{id}` | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| `POST /api/customers` | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| `PUT /api/customers/{id}` | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| `DELETE /api/customers/{id}` | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| `PUT /api/customers/profile` | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| `GET /api/customers/search` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `GET /api/customers/by-email` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `GET /api/customers/by-phone` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| `GET /api/customers/by-user/{userId}` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **WARRANTY CLAIMS** ‚úÖ (ƒê√É C√ì @PreAuthorize - SECURITY FIXED) |
| `GET /api/warranty-claims` | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| `GET /api/warranty-claims/{id}` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| `POST /api/warranty-claims` | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| `PUT /api/warranty-claims/{id}` | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| `DELETE /api/warranty-claims/{id}` | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| `PATCH /api/warranty-claims/{id}/status` | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| **CUSTOMER WARRANTY CLAIMS** üÜï (NEW - Oct 23, 2025) |
| `GET /api/warranty-claims/my-claims` | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| `GET /api/warranty-claims/my-claims/{id}` | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| **WORKFLOW ENDPOINTS** ‚úÖ (ƒê√É C√ì @PreAuthorize - SECURITY FIXED) |
| `POST /api/warranty-claims/sc-create` | ‚ùå | ‚ùå | ‚úÖ | ‚ùå | ‚ùå |
| `PATCH /api/warranty-claims/{id}/evm-accept` | ‚ùå | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| `PATCH /api/warranty-claims/{id}/evm-reject` | ‚ùå | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| `PATCH /api/warranty-claims/{id}/tech-start` | ‚ùå | ‚ùå | ‚ùå | ‚úÖ | ‚ùå |
| `PATCH /api/warranty-claims/{id}/tech-complete` | ‚ùå | ‚ùå | ‚ùå | ‚úÖ | ‚ùå |
| `GET /api/warranty-claims/evm-pending` | ‚ùå | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| `GET /api/warranty-claims/tech-pending` | ‚ùå | ‚ùå | ‚ùå | ‚úÖ | ‚ùå |
| `GET /api/warranty-claims/by-status/{status}` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| **SERVICE HISTORIES** ‚úÖ UPDATED - EVM_STAFF NOW HAS ACCESS |
| `GET /api/service-histories` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| `GET /api/service-histories/{id}` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ (v·ªõi business logic filtering) |
| `POST /api/service-histories` | ‚úÖ | ‚ùå | ‚úÖ | ‚úÖ | ‚ùå |
| `PUT /api/service-histories/{id}` | ‚úÖ | ‚ùå | ‚úÖ | ‚úÖ | ‚ùå |
| `DELETE /api/service-histories/{id}` | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| `GET /api/service-histories/by-vehicle/{id}` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ (v·ªõi business logic filtering) |
| `GET /api/service-histories/by-part/{id}` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| `GET /api/service-histories/my-services` | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| **USER MANAGEMENT** ‚úÖ NEW - ADMIN USER MANAGEMENT CAPABILITIES |
| `GET /api/admin/users` | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| `GET /api/admin/users/{id}` | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| `GET /api/admin/users/search` | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| `GET /api/admin/users/by-role/{role}` | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| `PUT /api/admin/users/{id}` | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| `PATCH /api/admin/users/{id}/role` | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| `PATCH /api/admin/users/{id}/status` | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| `DELETE /api/admin/users/{id}` | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| `POST /api/admin/users/{id}/reset-password` | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| `GET /api/admin/users/statistics` | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| **USER INFO** ‚úÖ FIXED - ROLE NAMING CORRECTED |
| `GET /api/me` | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |

## ‚úÖ **ƒê√É KH·∫ÆC PH·ª§C T·∫§T C·∫¢ V·∫§N ƒê·ªÄ B·∫¢O M·∫¨T**

### ‚úÖ **Warranty Claims Controller - ƒê√£ c√≥ b·∫£o m·∫≠t ho√†n ch·ªânh!**
**T·∫•t c·∫£ endpoints trong WarrantyClaimController ƒê√É C√ì @PreAuthorize annotation!**

ƒê√£ ƒë∆∞·ª£c s·ª≠a:
- ‚úÖ **Ph√¢n quy·ªÅn ch√≠nh x√°c** cho t·ª´ng endpoint theo business logic
- ‚úÖ **Workflow security** ƒë·∫£m b·∫£o ch·ªâ ƒë√∫ng role m·ªõi th·ª±c hi·ªán ƒë∆∞·ª£c action
- ‚úÖ **Role-based access** ho√†n to√†n ƒë∆∞·ª£c th·ª±c thi

### ‚úÖ **Service History Controller - EVM_STAFF ƒë√£ c√≥ quy·ªÅn truy c·∫≠p!**
**EVM_STAFF gi·ªù c√≥ th·ªÉ theo d√µi warranty claim completion!**

ƒê√£ ƒë∆∞·ª£c th√™m v√†o:
- ‚úÖ `GET /api/service-histories` - EVM c√≥ th·ªÉ xem t·∫•t c·∫£ service histories
- ‚úÖ `GET /api/service-histories/{id}` - EVM c√≥ th·ªÉ xem chi ti·∫øt
- ‚úÖ `GET /api/service-histories/by-vehicle/{id}` - EVM theo d√µi theo vehicle
- ‚úÖ `GET /api/service-histories/by-part/{id}` - EVM theo d√µi theo part

### ‚úÖ **UserInfo Controller - Role naming ƒë√£ ƒë∆∞·ª£c s·ª≠a!**
**Kh√¥ng c√≤n s·ª≠ d·ª•ng role names kh√¥ng t·ªìn t·∫°i!**

ƒê√£ s·ª≠a:
- ‚úÖ `hasRole("STAFF")` ‚Üí `hasRole("SC_STAFF")`
- ‚úÖ T·∫•t c·∫£ endpoints ƒë·ªÅu s·ª≠ d·ª•ng role names ch√≠nh x√°c
- ‚úÖ Security check ho·∫°t ƒë·ªông ƒë√∫ng theo thi·∫øt k·∫ø

### ‚úÖ **Status Transition Validation - ƒê√£ ƒë∆∞·ª£c implement!**
**Warranty claims kh√¥ng th·ªÉ chuy·ªÉn sang tr·∫°ng th√°i invalid!**

ƒê√£ t·∫°o:
- ‚úÖ `WarrantyClaimStatusValidator` class
- ‚úÖ Business rules validation cho t·∫•t c·∫£ status transitions
- ‚úÖ IllegalStateException cho invalid transitions

### ‚úÖ **User Management Controller - Admin c√≥ th·ªÉ qu·∫£n l√Ω t·∫•t c·∫£ users!**
**Admin gi·ªù c√≥ ƒë·∫ßy ƒë·ªß kh·∫£ nƒÉng qu·∫£n l√Ω user accounts!**

C√°c ch·ª©c nƒÉng m·ªõi:
- ‚úÖ **L·∫•y danh s√°ch users** v·ªõi pagination v√† filtering
- ‚úÖ **T√¨m ki·∫øm users** theo username ho·∫∑c role
- ‚úÖ **Xem chi ti·∫øt user** v·ªõi th√¥ng tin ƒë·∫ßy ƒë·ªß
- ‚úÖ **C·∫≠p nh·∫≠t th√¥ng tin user** bao g·ªìm email, status
- ‚úÖ **Thay ƒë·ªïi role** c·ªßa user
- ‚úÖ **K√≠ch ho·∫°t/v√¥ hi·ªáu h√≥a** user accounts
- ‚úÖ **Reset password** cho users
- ‚úÖ **X√≥a user** (soft delete)
- ‚úÖ **Th·ªëng k√™ users** theo role v√† tr·∫°ng th√°i

### ‚úÖ **API Endpoints ƒë√£ ƒë∆∞·ª£c t·∫°o:**
```
GET    /api/admin/users                    - L·∫•y t·∫•t c·∫£ users
GET    /api/admin/users/{userId}           - Xem chi ti·∫øt user
GET    /api/admin/users/search             - T√¨m ki·∫øm theo username
GET    /api/admin/users/by-role/{role}     - L·∫•y users theo role
PUT    /api/admin/users/{userId}           - C·∫≠p nh·∫≠t user
PATCH  /api/admin/users/{userId}/role      - Thay ƒë·ªïi role
PATCH  /api/admin/users/{userId}/status    - K√≠ch ho·∫°t/v√¥ hi·ªáu h√≥a
DELETE /api/admin/users/{userId}           - X√≥a user
POST   /api/admin/users/{userId}/reset-password - Reset m·∫≠t kh·∫©u
GET    /api/admin/users/statistics         - Th·ªëng k√™ users
```

### ‚úÖ **B·∫£o m·∫≠t ho√†n ch·ªânh:**
- T·∫•t c·∫£ endpoints ƒë·ªÅu c√≥ `@PreAuthorize("hasRole('ADMIN')")`
- Ch·ªâ Admin m·ªõi c√≥ quy·ªÅn truy c·∫≠p
- Class-level security annotation ƒë·∫£m b·∫£o kh√¥ng c√≥ endpoint n√†o b·ªã b·ªè s√≥t

---

## üÜï **T√çNH NƒÇNG M·ªöI: Customer Xem Warranty Claims** (Oct 23, 2025)

### **V·∫•n ƒë·ªÅ tr∆∞·ªõc ƒë√¢y:**
- ‚ùå Customer **KH√îNG TH·ªÇ** xem tr·∫°ng th√°i warranty claims c·ªßa m√¨nh
- ‚ùå Ph·∫£i g·ªçi ƒëi·ªán ho·∫∑c ƒë·∫øn trung t√¢m ƒë·ªÉ h·ªèi
- ‚ùå Kh√¥ng c√≥ t√≠nh minh b·∫°ch trong quy tr√¨nh

### **Gi·∫£i ph√°p:**
‚úÖ Th√™m 2 endpoints m·ªõi cho CUSTOMER:

#### **1. Xem t·∫•t c·∫£ claims c·ªßa m√¨nh**
```
GET /api/warranty-claims/my-claims?page=0&size=10
Authorization: Bearer <customer_token>

Response:
{
  "content": [
    {
      "warrantyClaimId": 1,
      "claimDate": "2024-10-20T10:00:00",
      "status": "PROCESSING",
      "description": "Battery not charging",
      "vehicleId": 5,
      "serviceCenterId": 1
    }
  ],
  "pageNumber": 0,
  "totalElements": 3
}
```

#### **2. Xem chi ti·∫øt 1 claim**
```
GET /api/warranty-claims/my-claims/1
Authorization: Bearer <customer_token>

Response:
{
  "warrantyClaimId": 1,
  "status": "COMPLETED",
  "description": "Battery replaced successfully",
  "resolutionDate": "2024-10-22T15:30:00"
}
```

### **B·∫£o m·∫≠t:**
- ‚úÖ Customer **CH·ªà** xem ƒë∆∞·ª£c claims c·ªßa xe m√¨nh s·ªü h·ªØu
- ‚úÖ Ki·ªÉm tra ownership ·ªü c·∫£ DB query v√† service layer
- ‚úÖ Kh√¥ng th·ªÉ xem claims c·ªßa ng∆∞·ªùi kh√°c
- ‚úÖ `@PreAuthorize("hasRole('CUSTOMER')")` tr√™n c·∫£ 2 endpoints

### **Implementation:**
```java
// Repository: Query qua Vehicle -> Customer relationship
findByVehicleCustomerCustomerId(customerId, pageable)

// Service: L·∫•y customer t·ª´ Security Context
String username = SecurityUtil.getCurrentUsername();
User user = userRepository.findByUsername(username);
Customer customer = user.getCustomer();

// Controller: @PreAuthorize b·∫£o v·ªá endpoint
@GetMapping("/my-claims")
@PreAuthorize("hasRole('CUSTOMER')")
public ResponseEntity<...> getMyWarrantyClaims(...)
```

### **L·ª£i √≠ch:**
- ‚úÖ Customer t·ª± theo d√µi tr·∫°ng th√°i claim
- ‚úÖ Gi·∫£m t·∫£i c√¥ng vi·ªác cho SC_STAFF
- ‚úÖ TƒÉng tr·∫£i nghi·ªám kh√°ch h√†ng
- ‚úÖ T√≠nh minh b·∫°ch cao h∆°n

### **Business Rule gi·ªØ nguy√™n:**
- ‚ùå Customer v·∫´n **KH√îNG TH·ªÇ** t·∫°o claim online
- ‚ùå Ph·∫£i ƒë·∫øn trung t√¢m ƒë·ªÉ SC_STAFF t·∫°o claim
- ‚úÖ Ch·ªâ **XEM** ƒë∆∞·ª£c tr·∫°ng th√°i, kh√¥ng s·ª≠a/x√≥a

---

**System Status:** ‚úÖ PRODUCTION READY - All security issues fixed + New customer features added
